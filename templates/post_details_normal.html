{% extends 'base.html' %}
{% load static %}
{% block title %}
    {{ post.post_title }}
{% endblock %} %}
{% block custom_style %}
    <style>
        .smaller-padding-with-vertical {
            padding-top: 5rem;
            padding-bottom: 5rem;
        }

        .blog-details-tag-area .tag-list li {
            background: none;
        }

        .comment-item .comment-content {
            z-index: 1000;
        }

        .panel-info {
            display: grid;
        }

        .panel-heading {
            justify-self: center;
        }

        .comment-thumb {
            border-radius: 50%;
        }

        input {
            text-transform: none;
        }

        .custom_title {
            margin-bottom: 0;
            height: 100%;
            line-height: 100%;
        }

        #review_button {
            cursor: not-allowed;
            background: -webkit-linear-gradient(20deg, #ff36a9 0%, #9459d4 54%, #297bff 91%);
            background: -ms-linear-gradient(20deg, #ff36a9 0%, #9459d4 54%, #297bff 91%);
            background: linear-gradient(20deg, #ff36a9 0%, #9459d4 54%, #297bff 91%);
        }
    </style>
{% endblock %}
{% block content %}
    <!-- inner-banner-section start -->
    <section class="inner-banner-section bg-overlay-primary bg_img smaller-padding-with-vertical"
             data-background="{{ post.post_image.url }}">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-12 text-center">
                    <div class="inner-content">
                        <h2 class="title wow fade-in-up" data-wow-duration="1s"
                            data-wow-delay="0.5s">{{ post.post_title }}</h2>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- inner-banner-section end -->


    <a href="#" class="scrollToTop"><i class="fas fa-heart"></i></a>


    <!-- breadcrumb-section start -->
    <div class="breadcrumb-area">
        <div class="container">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/index"><i class="flaticon-house"></i>主页</a></li>
                    <li class="breadcrumb-item"><i class="bi-house-heart-fill" style="font-size: 1.2rem"></i><a
                            href="/zone?zone_id={{ post.zone_id.zone_id }}">{{ post.zone_id.zone_name }}</a></li>
                </ol>
            </nav>
        </div>
    </div>
    <!-- breadcrumb-section end -->


    <!-- blog-section start -->
    <section class="blog-details-section ptb-120">
        <div class="container">
            <div class="row justify-content-center ml-b-30">
                <div class="col-lg-8 mrb-30">
                    <div class="blog-item mrb-60 wow fade-in-bottom" data-wow-duration="1s" data-wow-delay="0.5s">
                        <div class="blog-thumb">
                            <img src="{{ post.post_image.url }}" alt="blog">
                        </div>
                        <div class="blog-content blog-content-two">
                            <h3 class="title wow fade-in-up" data-wow-duration="1s"
                                data-wow-delay="0.5s">{{ post.post_title }}</h3>
                            <ul class="blog-content-list">
                                <li>
                                    <i class="fas fa-eye"></i><span>{{ post.post_view }}</span>
                                </li>
                                <li>
                                    <i class="fas fa-heart"></i><span>{{ post.post_like }}</span>
                                </li>
                                <li>
                                    <i class="fas fa-star"></i><span>{{ post.collection_set.count }}</span>
                                </li>
                                <li>
                                    <i class="fas fa-comment"></i><span>{{ post.review_set.count }}</span>
                                </li>
                            </ul>
                            {# post content section start #}
                            <div id="post-content">{{ post.post_content|safe }}</div>
                            {# post content section end #}
                            <div class="blog-details-tag-area d-flex flex-wrap justify-content-between ml-b-30">
                                <ul class="tag-list mrb-30">
                                    <li>
                                        <button id="post_like" class="button-85" role="button"
                                                onclick="update_post_like()">{% if post.is_liked %}取消点赞{% else %}
                                            点赞{% endif %}</button>
                                    </li>
                                    <li>
                                        <button id="post_collection" class="button-85" role="button"
                                                onclick="update_collection_post()">{% if post.is_collected %}
                                            取消收藏{% else %}收藏{% endif %}</button>
                                    </li>
                                    <!-- HTML !-->
                                </ul>
                                <div class="social-share" data-initialized="true"
                                     style="background: none; box-shadow: none">
                                    <a href="#" class="social-share-icon icon-weibo"></a>
                                    <a href="#" class="social-share-icon icon-qq"></a>
                                    <a href="#" class="social-share-icon icon-qzone"></a>
                                    <a href="#" class="social-share-icon icon-wechat"></a>
                                </div>
                            </div>
                            <div id="prev-and-next-buttons"
                                 class="blog-details-btn-area d-flex flex-wrap justify-content-between">
                                {% if prev_post %}
                                    <div class="btn-left">
                                        <a href="/post-{{ prev_post.post_layout_mode }}?post_id={{ prev_post.post_id }}"
                                           class="btn-border" style="padding: 12px 50px">上一篇</a>
                                    </div>
                                {% endif %}
                                {% if next_post %}
                                    <div class="btn-right">
                                        <a href="/post-{{ next_post.post_layout_mode }}?post_id={{ next_post.post_id }}"
                                           class="btn-border">下一篇</a>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="comments-section" id="reviews_area"></div>
                    <div id="leave-review" class="leave-review leave-comment">
                        <h3 class="title wow fade-in-up text-center" data-wow-duration="1s" data-wow-delay="0.5s">
                            发表评论</h3>
                        <form class="review-form" method="post" enctype="multipart/form-data" action="/review/publish/">
                            {% csrf_token %}
                            <div class="row">
                                <div class="col-sm-12 form-group wow fade-in-up" data-wow-duration="1s"
                                     data-wow-delay="0.5s">
                                    <label for="user_name">用户名:</label><input name="username" id="user_name"
                                                                                 type="text" placeholder="用户名"
                                                                                 value="{{ request.session.login_username }}"
                                                                                 readonly
                                                                                 style="float: left; margin-left: 30px; margin-top: -48px">
                                </div>
                                <div class="col-sm-12 form-group wow fade-in-up" data-wow-duration="1s"
                                     data-wow-delay="0.5s">
                                    <textarea placeholder="请在这里写评论..." id="review_content"
                                              name="review_content" onchange="validateForm()"
                                              onloadeddata="validateForm()" onmouseout="validateForm()"></textarea>
                                </div>
                                <div class="col-sm-12 form-group wow fade-in-up" data-wow-duration="1s"
                                     data-wow-delay="0.5s">
                                    <input type="hidden" name="user_id" id="user_id"
                                           value="{{ request.session.login_user_id }}">
                                    <input type="hidden" name="post_id" id="post_id" value="{{ post.post_id }}">
                                    <input type="hidden" id="parent_id" name="parent_id" value="">
                                    <input type="button" class="cmn-btn btn-border" id="review_button" value="发表评论"
                                           onclick="publish_review()">
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                {% include 'zone_and_post_widget.html' %}
            </div>
        </div>
    </section>
    <!-- blog-section start -->
{% endblock %}
{% block custom_script %}
    <script>
		function update_post_like() {
			let post_like_btn = document.getElementById("post_like");
			if (post_like_btn.innerHTML.trim() === "点赞") {
				$.ajax({
					url: "/post/like/",
					type: "POST",
					data: {
						"post_id": {{ post.post_id }},
						"method": "append",
						"csrfmiddlewaretoken": "{{ csrf_token }}",
					},
					success: function (data) {
						if (data === '200') {
							post_like_btn.innerHTML = "取消点赞";
						} else {
							let error_box = document.getElementById("error");
							let msg_node = document.createElement("li");
							msg_node.innerText = "点赞失败，" + data;
							error_box.childNodes[1].appendChild(msg_node);
							$('#error').show();
							auto_hide_error();
							setTimeout(function () {
								error_box.childNodes[1].removeChild(msg_node);
								check_error_and_success_list();
							}, 5000);
							console.log(data);
						}
					},
					error: function (data) {
						let error_box = document.getElementById("error");
						let msg_node = document.createElement("li");
						msg_node.innerText = "点赞失败，" + data;
						error_box.childNodes[1].appendChild(msg_node);
						$('#error').show();
						auto_hide_error();
						setTimeout(function () {
							error_box.childNodes[1].removeChild(msg_node);
							check_error_and_success_list();
						}, 5000);
						console.log(data);
					}
				});
			} else {
				$.ajax({
					url: "/post/like/",
					type: "POST",
					data: {
						"post_id": {{ post.post_id }},
						"method": "remove",
						"csrfmiddlewaretoken": "{{ csrf_token }}",
					},
					success: function (data) {
						if (data === '200') {
							post_like_btn.innerHTML = "点赞";
						} else {
							let error_box = document.getElementById("error");
							let msg_node = document.createElement("li");
							msg_node.innerText = "取消点赞失败，" + data;
							error_box.childNodes[1].appendChild(msg_node);
							$('#error').show();
							auto_hide_error();
							setTimeout(function () {
								error_box.childNodes[1].removeChild(msg_node);
								check_error_and_success_list();
							}, 5000);
							console.log(data);
						}
					},
					error: function (data) {
						let error_box = document.getElementById("error");
						let msg_node = document.createElement("li");
						msg_node.innerText = "取消点赞失败，" + data;
						error_box.childNodes[1].appendChild(msg_node);
						$('#error').show();
						auto_hide_error();
						setTimeout(function () {
							error_box.childNodes[1].removeChild(msg_node);
							check_error_and_success_list();
						}, 5000);
						console.log(data);
					}
				});
			}
		}

		function update_collection_post() {
			let post_like_btn = document.getElementById("post_collection");
			if (post_like_btn.innerHTML.trim() === "收藏") {
				$.ajax({
					url: "/post/collect/",
					type: "POST",
					data: {
						"post_id": {{ post.post_id }},
						"method": "append",
						"csrfmiddlewaretoken": "{{ csrf_token }}",
					},
					success: function (data) {
						if (data === '200') {
							post_like_btn.innerHTML = "取消收藏";
						} else {
							let error_box = document.getElementById("error");
							let msg_node = document.createElement("li");
							msg_node.innerText = "收藏失败，" + data;
							error_box.childNodes[1].appendChild(msg_node);
							$('#error').show();
							auto_hide_error();
							setTimeout(function () {
								error_box.childNodes[1].removeChild(msg_node);
								check_error_and_success_list();
							}, 5000);
							console.log(data);
						}
					},
					error: function (data) {
						let error_box = document.getElementById("error");
						let msg_node = document.createElement("li");
						msg_node.innerText = "收藏失败，" + data;
						error_box.childNodes[1].appendChild(msg_node);
						$('#error').show();
						auto_hide_error();
						setTimeout(function () {
							error_box.childNodes[1].removeChild(msg_node);
							check_error_and_success_list();
						}, 5000);
						console.log(data);
					}
				});
			} else {
				$.ajax({
					url: "/post/collect/",
					type: "POST",
					data: {
						"post_id": {{ post.post_id }},
						"method": "remove",
						"csrfmiddlewaretoken": "{{ csrf_token }}",
					},
					success: function (data) {
						if (data === '200') {
							post_like_btn.innerHTML = "收藏";
						} else {
							let error_box = document.getElementById("error");
							let msg_node = document.createElement("li");
							msg_node.innerText = "取消收藏失败，" + data;
							error_box.childNodes[1].appendChild(msg_node);
							$('#error').show();
							auto_hide_error();
							setTimeout(function () {
								error_box.childNodes[1].removeChild(msg_node);
								check_error_and_success_list();
							}, 5000);
							{#console.log(data);#}
						}
					},
					error: function (data) {
						let error_box = document.getElementById("error");
						let msg_node = document.createElement("li");
						msg_node.innerText = "取消收藏失败，" + data;
						error_box.childNodes[1].appendChild(msg_node);
						$('#error').show();
						auto_hide_error();
						setTimeout(function () {
							error_box.childNodes[1].removeChild(msg_node);
							check_error_and_success_list();
						}, 5000);
						{#console.log(data);#}
					}
				});
			}
		}

		{#layout prev and next buttons#}
		$(document).ready(function () {
			let area = document.getElementById("prev-and-next-buttons");
			if (area.children.length === 1) {
				area.classList.remove("justify-content-between");
				area.classList.add("justify-content-center");
			} else {
				area.classList.remove("justify-content-center");
				area.classList.add("justify-content-between");
			}
		})


		{#get all reviews for post#}
		$(document).ready(function () {
			get_all_reviews();
		})

		function get_all_reviews() {
			let reviews = document.getElementById("reviews_area");
			reviews.style.display = "grid";
			$.ajax({
				url: "/review/get/all/",
				type: "POST",
				enctype: 'application/json',
				data: {
					"post_id": {{ post.post_id }},
					"csrfmiddlewaretoken": "{{ csrf_token }}",
				},
				success: function (data) {
					if (data.code === 200) {
						let reviews_summary = document.createElement("h3");
						reviews_summary.style.marginBottom = "0";
						reviews_summary.classList.add("custom_title");
						reviews_summary.classList.add("title");
						reviews_summary.innerText = data.all_reviews_count + "条评论";
						if (data.data.length === 0) {
							reviews_summary.style.justifySelf = "center";
							reviews_summary.innerText = "暂无评论";
						}
						reviews.appendChild(reviews_summary);
						let reviews_wrapper = document.createElement("ul");
						reviews_wrapper.id = "reviews_wrapper";
						reviews_wrapper.classList.add("comment-wrapper");
						let load_more_btn = document.createElement("button");
						load_more_btn.style.display = "none";
						load_more_btn.classList.add("cmn-btn");
						load_more_btn.innerText = "加载更多";
						if (data.all_reviews_count > 10) {
							load_more_btn.style.display = "block";
							load_more_btn.addEventListener("click", get_more_reviews);
						}
						for (const review_i in data.data) {
							let review_item = document.createElement("li");
							let time_period = formatTimePeriod(Date.now() - Date.parse(data.data[review_i].review_time));
							{#console.log(time_period);#}
							if (data.data[review_i].children_count > 0) {
								review_item.innerHTML = `
                                <div class="comment-item">
                                    <div class="comment-thumb">
                                        <a href="/user/?user_id=${data.data[review_i].author.user_id}"><img src="${data.data[review_i].author.user_headicon}"
                                                         alt="blog"></a>
                                    </div>
                                    <div class="comment-content">
                                        <h5 class="sub-title wow fade-in-up" data-wow-duration="1s"
                                            data-wow-delay="0.5s"><a href="/user/?user_id=${data.data[review_i].author.user_id}">${data.data[review_i].author.username}</a></h5>
                                        <span class="wow fade-in-up" data-wow-duration="1s" data-wow-delay="0.5s">${time_period}</span>
                                        <p class="wow fade-in-bottom" data-wow-duration="1s" data-wow-delay="0.5s">${data.data[review_i].content}</p>
                                        <a href="#leave-review"
                                        onclick="assignment_parent_id(${data.data[review_i].review_id}, '${data.data[review_i].author.username}', '${data.data[review_i].content}')" class="reply-button">回复</a>
                                    </div>
								    <div class="panel-group" style="width: 100%" id="accordion-${data.data[review_i].review_id}">
                                        <div class="panel panel-info">
                                            <div class="panel-heading">
                                                <h4 class="panel-title">
                                                    <a id="reply-list-button-${data.data[review_i].review_id}" style="color: white" onclick="get_review_children(${data.data[review_i].review_id})" data-toggle="collapse" data-parent="#accordion-${data.data[review_i].review_id}"
                                                       href="#reply-${data.data[review_i].review_id}" class="cmn-btn">
                                                        展开回复列表
                                                    </a>
                                                </h4>
                                            </div>
                                            <ul id="reply-${data.data[review_i].review_id}" class="reply-wrapper panel-collapse collapse">
                                            </ul>
                                        </div>
                                    </div>
                                </div>
								`;
							} else {
								review_item.innerHTML = `
                                <div class="comment-item">
                                    <div class="comment-thumb">
                                        <a href="/user/?user_id=${data.data[review_i].author.user_id}"><img src="${data.data[review_i].author.user_headicon}"
                                                         alt="blog"></a>
                                    </div>
                                    <div class="comment-content">
                                        <h5 class="sub-title wow fade-in-up" data-wow-duration="1s"
                                            data-wow-delay="0.5s"><a href="/user/?user_id=${data.data[review_i].author.user_id}">${data.data[review_i].author.username}</a></h5>
                                        <span class="wow fade-in-up" data-wow-duration="1s" data-wow-delay="0.5s">${time_period}</span>
                                        <p class="wow fade-in-bottom" data-wow-duration="1s" data-wow-delay="0.5s">${data.data[review_i].content}</p>
                                        <a href="#leave-review"
                                        onclick="assignment_parent_id(${data.data[review_i].review_id}, '${data.data[review_i].author.username}', '${data.data[review_i].content}')" class="reply-button">回复</a>
                                    </div>
                                </div>
                                `;
							}
							reviews_wrapper.appendChild(review_item);
						}
						reviews.appendChild(reviews_wrapper);
						try {
							reviews.appendChild(load_more_btn);
						} catch (e) {
							console.log(e);
						}
					} else {
						let error_box = document.getElementById("error");
						let msg_node = document.createElement("li");
						msg_node.innerText = "评论加载失败，" + data.msg;
						error_box.childNodes[1].appendChild(msg_node);
						$('#error').show();
						auto_hide_error();
						setTimeout(function () {
							error_box.childNodes[1].removeChild(msg_node);
							check_error_and_success_list();
						}, 5000);
						{#console.log(data);#}
					}
				},
				error: function (data) {
					let error_box = document.getElementById("error");
					let msg_node = document.createElement("li");
					msg_node.innerText = "评论加载失败，" + data.msg;
					error_box.childNodes[1].appendChild(msg_node);
					$('#error').show();
					auto_hide_error();
					setTimeout(function () {
						error_box.childNodes[1].removeChild(msg_node);
						check_error_and_success_list();
					}, 5000);
					{#console.log(data);#}
				}
			})
		}

		{#get and layout review children#}
		let counter = {};

		function get_review_children(review_id) {
			$.ajax({
				url: "/review/get/children/",
				type: "POST",
				enctype: 'application/json',
				data: {
					"review_id": review_id,
					"csrfmiddlewaretoken": "{{ csrf_token }}",
				},
				success: function (data) {
					if (data.code === 200) {
						counter[review_id] = counter[review_id] || {};
						counter[review_id]['parent_id'] = counter[review_id]['parent_id'] || data.parent_id;
						counter[review_id]['count'] = counter[review_id]['count'] || 0;
						let review_children = document.getElementById("reply-" + review_id);
						if (data.data.length <= 0) {
							document.getElementById("accordion-" + review_id).parentNode.removeChild(document.getElementById("accordion-" + review_id));
						} else {
							if (counter[review_id]['count'] % 2 === 0) {
								for (const child_i in data.data) {
									let child = document.createElement("li");
									let time_period = formatTimePeriod(Date.now() - Date.parse(data.data[child_i].review_time));
									if (data.data[child_i].children_count > 0) {
										child.innerHTML = `
                                        <div class="comment-item">
                                            <div class="comment-thumb">
                                                <a href="/user/?user_id=${data.data[child_i].author.user_id}"><img src="${data.data[child_i].author.user_headicon}"
                                                         alt="blog"></a>
                                            </div>
                                            <div class="comment-content">
                                                <h5 class="sub-title wow fade-in-up" data-wow-duration="1s"
                                                    data-wow-delay="0.5s"><a href="/user/?user_id=${data.data[child_i].author.user_id}">${data.data[child_i].author.username}</a></h5>
                                                <span class="wow fade-in-up" data-wow-duration="1s" data-wow-delay="0.5s">${time_period}</span>
                                                <p class="wow fade-in-bottom" data-wow-duration="1s" data-wow-delay="0.5s">${data.data[child_i].content}</p>
                                                <a href="#leave-review"
                                                onclick="assignment_parent_id(${data.data[child_i].review_id}, '${data.data[child_i].author.username}', '${data.data[child_i].content}')" class="reply-button">回复</a>
                                            </div>
                                            <div class="panel-group" style="width: 100%" id="accordion-${data.data[child_i].review_id}">
                                                <div class="panel panel-info">
                                                    <div class="panel-heading">
                                                        <h4 class="panel-title">
                                                            <a id="reply-list-button-${data.data[child_i].review_id}" style="color: white" onclick="get_review_children(${data.data[child_i].review_id})" data-toggle="collapse" data-parent="#accordion-${data.data[child_i].review_id}"
                                                               href="#reply-${data.data[child_i].review_id}" class="cmn-btn">
                                                                展开回复列表
                                                            </a>
                                                        </h4>
                                                    </div>
                                                    <ul id="reply-${data.data[child_i].review_id}" class="reply-wrapper panel-collapse collapse">
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
							            `;
									} else {
										child.innerHTML = `
                                        <div class="comment-item">
                                            <div class="comment-thumb">
                                                <a href="/user/?user_id=${data.data[child_i].author.user_id}"><img src="${data.data[child_i].author.user_headicon}"
                                                         alt="blog"></a>
                                            </div>
                                            <div class="comment-content">
                                                <h5 class="sub-title wow fade-in-up" data-wow-duration="1s"
                                                    data-wow-delay="0.5s"><a href="/user/?user_id=${data.data[child_i].author.user_id}">${data.data[child_i].author.username}</a></h5>
                                                <span class="wow fade-in-up" data-wow-duration="1s" data-wow-delay="0.5s">${time_period}</span>
                                                <p class="wow fade-in-bottom" data-wow-duration="1s" data-wow-delay="0.5s">${data.data[child_i].content}</p>
                                                <a href="#leave-review"
                                                onclick="assignment_parent_id(${data.data[child_i].review_id}, '${data.data[child_i].author.username}', '${data.data[child_i].content}')" class="reply-button">回复</a>
                                            </div>
                                        </div>
							            `;
									}
									review_children.appendChild(child);
								}
								document.getElementById(`reply-list-button-${review_id}`).removeEventListener('click', function () {
									get_review_children(review_id);
								});
								document.getElementById(`reply-list-button-${review_id}`).innerText =
									document.getElementById(`reply-list-button-${review_id}`).innerText.replaceAll("展开", "收起");
							} else {
								document.getElementById(`reply-list-button-${review_id}`).innerText =
									document.getElementById(`reply-list-button-${review_id}`).innerText.replace("收起", "展开");
								review_children.innerHTML = "";
							}
							counter[review_id]['count']++;
						}
					} else {
						let error_box = document.getElementById("error");
						let msg_node = document.createElement("li");
						msg_node.innerText = "回复加载失败，" + data.msg;
						error_box.childNodes[1].appendChild(msg_node);
						$('#error').show();
						auto_hide_error();
						setTimeout(function () {
							error_box.childNodes[1].removeChild(msg_node);
							check_error_and_success_list();
						}, 5000);
						{#console.log(data);#}
					}
				},
				error: function (data) {
					let error_box = document.getElementById("error");
					let msg_node = document.createElement("li");
					msg_node.innerText = "回复加载失败，" + data.msg;
					error_box.childNodes[1].appendChild(msg_node);
					$('#error').show();
					auto_hide_error();
					setTimeout(function () {
						error_box.childNodes[1].removeChild(msg_node);
						check_error_and_success_list();
					}, 5000);
					{#console.log(data);#}
					{#console.log(data);#}
				}
			})
		}


		let parent_count = 0;

		function check_counter(temp_parent_id) {
			for (const item in counter) {
				// 检查当前项是否有parent_id属性，且等于传入的temp_parent_id
				if (counter[item]['parent_id'] === temp_parent_id) {
					parent_count++;
					// 递归调用，检查当前项的子集
					parent_count += check_counter(item);
				}
			}
			// 判断递归回复子集数量是否超过4个
			return parent_count <= 4;
		}

		let page_num = 1;

		function get_more_reviews() {
			let reviews = document.getElementById("reviews_area");
			$.ajax({
				url: "/review/get/more/",
				type: "POST",
				enctype: 'application/json',
				data: {
					"post_id": {{ post.post_id }},
					"page": page_num++,
					"csrfmiddlewaretoken": "{{ csrf_token }}",
				},
				success: function (data) {
					if (data.code === 200) {
						let reviews_wrapper = document.getElementById("reviews_wrapper");
						let load_more_btn = document.createElement("button");
						load_more_btn.classList.add("cmn-btn");
						load_more_btn.innerText = "加载更多";
						load_more_btn.style.display = "none";
						for (const review_i in data.data) {
							let review_item = document.createElement("li");
							let time_period = formatTimePeriod(Date.now() - Date.parse(data.data[review_i].review_time));
							{#console.log(time_period);#}
							if (data.data[review_i].children_count > 0) {
								review_item.innerHTML = `
                                <div class="comment-item">
                                    <div class="comment-thumb">
                                        <a href="/user/?user_id=${data.data[review_i].author.user_id}"><img src="${data.data[review_i].author.user_headicon}"
                                                         alt="blog"></a>
                                    </div>
                                    <div class="comment-content">
                                        <h5 class="sub-title wow fade-in-up" data-wow-duration="1s"
                                            data-wow-delay="0.5s"><a href="/user/?user_id=${data.data[review_i].author.user_id}">${data.data[review_i].author.username}</a></h5>
                                        <span class="wow fade-in-up" data-wow-duration="1s" data-wow-delay="0.5s">${time_period}</span>
                                        <p class="wow fade-in-bottom" data-wow-duration="1s" data-wow-delay="0.5s">${data.data[review_i].content}</p>
                                        <a href="#leave-review" onclick="assignment_parent_id(${data.data[review_i].review_id})" class="reply-button">回复</a>
                                    </div>
								    <div class="panel-group" style="width: 100%" id="accordion-${data.data[review_i].review_id}">
                                        <div class="panel panel-info">
                                            <div class="panel-heading">
                                                <h4 class="panel-title">
                                                    <a id="reply-list-button-${data.data[review_i].review_id}" style="color: white" onclick="get_review_children(${data.data[review_i].review_id})" data-toggle="collapse" data-parent="#accordion-${data.data[review_i].review_id}"
                                                       href="#reply-${data.data[review_i].review_id}" class="cmn-btn">
                                                        展开回复列表
                                                    </a>
                                                </h4>
                                            </div>
                                            <ul id="reply-${data.data[review_i].review_id}" class="reply-wrapper panel-collapse collapse">
                                            </ul>
                                        </div>
                                    </div>
                                </div>
								`;
								get_review_children(data.data[review_i].review_id);
							} else {
								review_item.innerHTML = `
                                <div class="comment-item">
                                    <div class="comment-thumb">
                                        <a href="/user/?user_id=${data.data[review_i].author.user_id}"><img src="${data.data[review_i].author.user_headicon}"
                                                         alt="blog"></a>
                                    </div>
                                    <div class="comment-content">
                                        <h5 class="sub-title wow fade-in-up" data-wow-duration="1s"
                                            data-wow-delay="0.5s"><a href="/user/?user_id=${data.data[review_i].author.user_id}">${data.data[review_i].author.username}</a></h5>
                                        <span class="wow fade-in-up" data-wow-duration="1s" data-wow-delay="0.5s">${time_period}</span>
                                        <p class="wow fade-in-bottom" data-wow-duration="1s" data-wow-delay="0.5s">${data.data[review_i].content}</p>
                                        <a href="#leave-review"
                                        onclick="assignment_parent_id(${data.data[review_i].review_id}, '${data.data[review_i].author.username}', '${data.data[review_i].content}')" class="reply-button">回复</a>
                                    </div>
                                </div>
                                `;
							}
							reviews_wrapper.appendChild(review_item);
						}
						try {
							if (data.data.length < 10) {
								reviews.lastChild.remove();
							} else if (data.all_reviews_count > page_num * 10) {
							} else {
								reviews.lastChild.remove();
							}
						} catch (e) {
							console.log(e);
						}
					} else {
						let error_box = document.getElementById("error");
						let msg_node = document.createElement("li");
						msg_node.innerText = "评论加载失败，" + data.msg;
						error_box.childNodes[1].appendChild(msg_node);
						$('#error').show();
						auto_hide_error();
						setTimeout(function () {
							error_box.childNodes[1].removeChild(msg_node);
							check_error_and_success_list();
						}, 5000);
						{#console.log(data);#}
					}
				},
				error: function (data) {
					let error_box = document.getElementById("error");
					let msg_node = document.createElement("li");
					msg_node.innerText = "评论加载失败，" + data.msg;
					error_box.childNodes[1].appendChild(msg_node);
					$('#error').show();
					auto_hide_error();
					setTimeout(function () {
						error_box.childNodes[1].removeChild(msg_node);
						check_error_and_success_list();
					}, 5000);
					{#console.log(data);#}
				}
			})
		}

		function formatTimePeriod(timePeriod) {
			const seconds = Math.floor(timePeriod / 1000);
			const minutes = Math.floor(seconds / 60);
			const hours = Math.floor(minutes / 60);
			const days = Math.floor(hours / 24);
			const weeks = Math.floor(days / 7);
			const months = Math.floor(days / 30);
			const years = Math.floor(days / 365);

			if (years > 0) {
				return `${years}
								年前`;
			} else if (months > 0) {
				return `${months}
								个月前`;
			} else if (weeks > 0) {
				return `${weeks}
								周前`;
			} else if (days > 0) {
				return `${days}
								天前`;
			} else if (hours > 0) {
				return `${hours}
								小时前`;
			} else if (minutes > 0) {
				return `${minutes}
								分钟前`;
			} else if (seconds > 0) {
				return `${seconds}
								秒前`;
			} else {
				console.error('未来者时间，请站长注意！timePeriod is invalid!');
				return '未来者时间，请站长注意！';
			}
		}

		function validateForm() {
			let user_id = document.getElementById("user_id").value;
			let post_id = document.getElementById("post_id").value;
			let parent_id = document.getElementById("parent_id").value;
			let review_content = document.getElementById("review_content").value;
			let review_button = document.getElementById("review_button");
			if (user_id.length === 0) {
				show_and_hide_error("请先登录");
				review_button.style.cursor = "not-allowed";
				return false;
			} else if (post_id.length === 0) {
				show_and_hide_error("非法请求，请先选择文章");
				review_button.style.cursor = "not-allowed";
				return false;
			} else if (review_content.length < 5) {
				{#console.log(review_content)#}
				show_and_hide_error("评论内容太少了，再写点儿吧！");
				review_button.style.cursor = "not-allowed";
				return false;
			} else {
				if (!/^[0-9]{1,30}$/.test(user_id)) {
					show_and_hide_error("非法请求，请先选择文章");
					review_button.style.cursor = "not-allowed";
					return false;
				} else {
					if (!(/^[0-9]{1,30}$/.test(parent_id) || parent_id === "")) {
						show_and_hide_error("非法请求，请核实后重试");
						review_button.style.cursor = "not-allowed";
						return false;
					} else {
						if (!/^[\u4E00-\u9FA5A-Za-z0-9]{3,200}$/.test(review_content)) {
							show_and_hide_error("评论内容不合法或超过200个字符，请核实后重试！");
							review_button.style.cursor = "not-allowed";
							return false;
						} else {
							review_button.style.cursor = "pointer";
							return true;
						}
					}
				}
			}
		}

		function assignment_parent_id(review_id, review_author, review_content) {
			let parent_id_node = document.getElementById("parent_id");
			let review_button = document.getElementById("review_button");
			let review_content_node = document.getElementById("review_content");
			parent_id_node.value = review_id;
			review_content_node.value = "";
			review_content_node.placeholder = "@" + review_author + ":" + review_content;
			review_button.value = "回复评论";
		}

		function publish_review() {
			if (validateForm()) {
				$.ajax({
					url: "/api/post/review/",
					type: "POST",
					data: {
						user_id: document.getElementById("user_id").value,
						post_id: document.getElementById("post_id").value,
						parent_id: document.getElementById("parent_id").value,
						review_content: document.getElementById("review_content").value,
						csrfmiddlewaretoken: '{{ csrf_token }}'
					},
					success: function (data) {
						if (data.status === 200) {
							show_and_hide_success("评论成功");
							document.getElementById("review_content").textContent = "";
							document.getElementById("parent_id").value = "";
							document.getElementById("reviews_area").innerHTML = "";
							setTimeout(function () {
								window.location.reload();
							}, 1500);
						} else {
							show_and_hide_error("评论失败，" + data.msg);
						}
					},
					error: function (data) {
						show_and_hide_error("评论失败，" + data.msg);
					}
				})
			}
		}
    </script>
{% endblock %}